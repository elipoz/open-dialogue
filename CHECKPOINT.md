# Checkpoint

**Date:** 2026-02-21

## Summary

Open Dialogue with AI — Streamlit app for N-way dialogue between multiple Moderators, and two AI agents (separate OpenAI sessions per agent). Conversations and messages are persisted in Supabase; each conversation has a UUID in the URL.

**Recent:** Agent reply streams only inside the **Conversation history** panel (as a chat message in the same list as previous messages). Streaming uses plain text in the placeholder to avoid brief font/size jumps from partial markdown; the final message in history still renders with full markdown. **Agent-to-agent:** Agents can trigger each other by @mention or by naming the other (e.g. "Joshi, what do you think?"); with probability P (0–0.5, editable in sidebar) the other agent may also be triggered after a reply; cap N (0–10) limits consecutive agent messages. Sidebar has editable **Agent chain cap (N)** and **Agent reply probability (P)** above Participants; P=0 disables random chain (only @mention/name triggers); N=0 or N=1 means no chain. When the human says e.g. "@j can ask Gosha to respond?", Gosha is triggered after Joshi replies (trigger_after_mention_chain).

**Live app:** https://open-dialogue-with-ai.streamlit.app/

## Features

- **Login gate:** Single combined screen: **"To start a dialogue - state your name"**; name field (max 15 chars), then password when required (Streamlit Cloud with `APP_PASSWORD` or `APP_ADMIN_PASSWORD` set), then **Submit**. **Admin:** log in with name **Admin** and `APP_ADMIN_PASSWORD`; only that user can delete conversations (× disabled for others; tooltip "Only Admin can delete conversations"). Other users use `APP_PASSWORD`. Page title becomes **"&lt;name&gt;'s Open Dialogue with AI"** once set. Conversation history and export use the **original author name** for each message (from DB when loaded); new messages use current user name.
- **Send as:** Moderator (default) or Instructor. Single chat input; press Enter to send. Role keys use constants `ROLE_MODERATOR` / `ROLE_INSTRUCTOR` in code.
- **Two agents:** Configurable names and roles in `app.py` (e.g. Gosha, Joshi). Agent name is fixed; only role text is editable. Collapsible role expander and **Respond** button per agent. OpenAI prompts enforce fixed identity: each agent must speak only for themselves, never as Instructor/Moderator/other agent.
- **Agent intro:** Each agent states name and role on first reply and again after its role is updated.
- **Thinking spinner:** One place for both flows — **Respond** or @mention; "agent thinking…" appears in the same full-width row below the agent rows. Agent reply text streams only in the right column inside **Conversation history** (as a chat bubble in the message list), not under the spinner.
- **Streaming:** Reply is streamed into a placeholder inside the conversation history list (same `st.chat_message` style). Placeholder uses plain text during stream to avoid font/size glitches from partial markdown; saved message in history is rendered with markdown.
- **@mentions:** When **Moderator** posts a message that @-mentions an agent, that agent is triggered (every time; no suppression). **Respond** button also triggers. Instructor messages never trigger agents; we clear agent thinking on every new message, then set from @mention only when role is Moderator. Mention pattern: `@` (optional space) then first letter or any prefix of name (e.g. `@g`, `@ gosha`). Stored text is expanded to full agent names in history and for OpenAI. If the human also names the other agent (e.g. "@j can ask Gosha to respond?"), that agent is triggered after the @mentioned agent replies (`trigger_after_mention_chain`).
- **Agent-to-agent:** After an agent replies, the other agent can be triggered by @mention or by naming them in the reply (e.g. "Joshi, what do you think?"); with probability P (sidebar, 0–0.5) they may also be triggered at random. Consecutive agent messages are capped at N (sidebar, 0–10); N=0 or N=1 means no chain. P=0 disables probability (only @mention/name triggers). Session state: `agent_chain_count` (reset on human message or Respond), `agent_cross_mention_n` / `agent_cross_mention_p` (from sidebar inputs).
- **Layout:** Sidebar with conversations list, divider, **Agent chain cap (N)** and **Agent reply probability (P)** inputs (0–10 and 0–0.5; used for agent-to-agent chains), **Participants** expander (human users who posted as Moderator only; Instructor not listed), **Request / response log**. Main: 50% left (controls + spinner), 50% right (conversation history). Above "Conversation history" subheader: **Reverse order** (left) and **Export to doc** (right) when there is dialogue.
- **Conversation history:** Right panel, newest first by default; **Reverse order** toggles; timestamps; each message shows the original poster’s name (DB author or current user for new messages). **Export to doc** downloads full conversation as .docx (via `doc_export.py`). Dialogue loaded from DB before title so Participants list is correct on join.
- **Supabase:** `SUPABASE_URL` and `SUPABASE_KEY` (or anon JWT) in `.env`. New conversation is created **only** when the user clicks **New conversation** (no auto-creation on load). `create_conversation()` passes current UTC time as `created_at` so the timestamp is accurate. On start, if the URL has no valid `conversation_id` and nothing is selected, the app auto-selects the most recent conversation; when the URL has `?conversation_id=<uuid>`, that conversation is always used (URL wins). `od_conversations` has id + created_at (no moderator_name). `od_messages` stores author display name in `role` (human or agent name). Sidebar lists previous conversations (by created_at); current conversation highlighted in red; each row has an **×** button to delete (removes from DB and panel; if current, app switches to a new conversation). Opening a link with `?conversation_id=<uuid>` prompts for name then loads that conversation’s entire history. Tables: run `supabase_migration.sql` in Supabase SQL Editor (includes DROP then CREATE).
- **Multi-user sync:** Multiple users share the same conversation. **2s fragment** (right column) polls and reloads dialogue from DB so history stays in sync; **10s fragment** (sidebar) refreshes the conversation list. Conversation/query state preserved when URL param is missing (no accidental reset); sidebar only clears current when list is non-empty and current id missing. After every `persist_message` (human message, agent reply, role update) we call `_reload_dialogue_from_db()` so the UI always shows the canonical DB state. New conversation is prepended to the list when created. `conversation_exists()`; opening or polling a deleted conversation clears state and reloads. **Dedupe** by conversation id; if current conversation is missing from the list (deleted by another user), selection is cleared. Session-state reset in `_clear_conversation_state()`. Agent intro flags (`agent1_needs_intro`, `agent2_needs_intro`) are synced from dialogue when loading from DB (`_sync_agent_intro_state_from_dialogue()`) so agents don’t re-introduce if they already have messages in the conversation.
- **Timestamps in PST:** All UI timestamps in **America/Los_Angeles (PST)**. `_format_in_pst()` handles both datetime and ISO strings from Supabase; new conversation label uses `_now_pst()`.
- **OpenAI context:** Conversation sent to OpenAI as **one [user] message**: full transcript with **"At &lt;timestamp&gt; &lt;role&gt; said: &lt;message&gt;"** (chronological, including this agent's past replies) then **[Reply now only as &lt;name&gt;.]**. No per-turn user/assistant; who said what is clear from the transcript. Timestamp is message `created_at` from DB; role uses actual names. Agent system prompt instructs: reply with message content only—do not echo "At … said:" or your name as a label.
- **Agent replies:** If the model echoes "At &lt;timestamp&gt; &lt;name&gt; said:" we strip it (`_strip_at_timestamp_said_prefix`); leading "Name: " is also stripped (`_strip_agent_name_prefix`) so the UI label is not duplicated.
- **Refactoring:** Agent thinking flow in `_run_agent_thinking_if_set(agent_key, agent_name)`; agent role row (expander + form + Respond button) in `_render_agent_role_row(agent_key, agent_name, agent_role, role_col, button_col)`.
- **Password (Streamlit Cloud):** When `APP_PASSWORD` or `APP_ADMIN_PASSWORD` is set and running on Streamlit Cloud, the login screen includes name + password + Submit (password omitted when running locally). Admin logs in with name "Admin" and `APP_ADMIN_PASSWORD`; others use `APP_PASSWORD`.
- **Tavily:** Optional `TAVILY_API_KEY` in `.env` for agent web search. Status line under title shows enabled / disabled / error (only after moderator name is set; not on the name-entry page).
- **Model:** OpenAI model **gpt-5-mini** (no temperature param; model uses default). Agent prompt instructs taking a different perspective from the other agent when relevant.
- **Request / response log:** In sidebar below Participants; latest request and response after each Respond or @mention. Two collapsible subsections (Request, Response) inside the main expander; long content shown as equal-length prefix + "..." + suffix via `_truncate_middle`. Widget keys include log ts+agent so content refreshes when a new agent reply is logged (avoids stale Streamlit session state). Log written in `_run_agent_thinking_if_set` after `call_openai_for_agent` returns.
- **Timestamps in DB:** Messages stored with UTC `created_at` so all users have consistent timestamps regardless of app host.

## Files

- `app.py` — main Streamlit app
- `supabase_client.py` — Supabase client and helpers (conversation_exists, create_conversation, delete_conversation, list_conversations, load_messages, persist_message)
- `doc_export.py` — export dialogue to Word (.docx)
- `supabase_migration.sql` — DROP + CREATE for `od_conversations` and `od_messages` (run in Supabase SQL Editor)
- `pyproject.toml` — dependencies (streamlit, openai, python-dotenv, python-docx, supabase, tavily-python)
- `README.md` — setup and usage
- `SUPABASE_PLAN.md` — Supabase integration plan and schema notes
